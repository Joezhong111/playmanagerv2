# ç³»ç»Ÿæ¶æ„è®¾è®¡

## ğŸ—ï¸ æ€»ä½“æ¶æ„

é™ªç©ç®¡ç†ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œç»“åˆå¾®æœåŠ¡è®¾è®¡ç†å¿µï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œé«˜æ€§èƒ½ã€‚

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            è¡¨ç°å±‚ (Presentation)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Login Page  â”‚  â”‚Dispatcher  â”‚  â”‚ Player Page â”‚  â”‚Task Focus  â”‚  â”‚Error Pages  â”‚ â”‚
â”‚  â”‚             â”‚  â”‚   Dashboard â”‚  â”‚  Dashboard  â”‚  â”‚   Mode      â”‚  â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             åº”ç”¨å±‚ (Application)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        API Gateway (Express)                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚   Router    â”‚  â”‚ Middleware  â”‚  â”‚  Auth       â”‚  â”‚ Rate Limit  â”‚ â”‚ â”‚
â”‚  â”‚ â”‚   Handler   â”‚  â”‚   Chain     â”‚  â”‚   Service    â”‚  â”‚   Control   â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                    â”‚                    â”‚                    â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   User Service  â”‚  â”‚   Task Service  â”‚  â”‚   Stats Serviceâ”‚  â”‚  Notify Serviceâ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚ â”‚
â”‚  â”‚ â€¢ Authenticationâ”‚  â”‚ â€¢ Task CRUD     â”‚  â”‚ â€¢ Analytics    â”‚  â”‚ â€¢ WebSocket    â”‚ â”‚
â”‚  â”‚ â€¢ Authorization â”‚  â”‚ â€¢ Assignment   â”‚  â”‚ â€¢ Reports      â”‚  â”‚ â€¢ Email/SMS    â”‚ â”‚
â”‚  â”‚ â€¢ User Profile  â”‚  â”‚ â€¢ Timer Mgmt   â”‚  â”‚ â€¢ Metrics      â”‚  â”‚ â€¢ Push Notify  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Database Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ•°æ®å±‚ (Data Layer)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         MySQL Database            â”‚  â”‚          Redis Cache            â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   users      â”‚  â”‚   tasks      â”‚  â”‚ â”‚  sessions    â”‚  â”‚   user_data â”‚   â”‚
â”‚  â”‚   user_logs  â”‚  â”‚   task_logs  â”‚  â”‚ â”‚  task_cache  â”‚  â”‚   stats     â”‚   â”‚
â”‚  â”‚   sessions   â”‚  â”‚   statistics â”‚  â”‚ â”‚  rate_limits â”‚  â”‚   online_usersâ”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)
æ¯ä¸ªç»„ä»¶å’ŒæœåŠ¡éƒ½æœ‰æ˜ç¡®çš„å•ä¸€èŒè´£ï¼š
- **User Service**: åªè´Ÿè´£ç”¨æˆ·ç›¸å…³ä¸šåŠ¡é€»è¾‘
- **Task Service**: åªè´Ÿè´£ä»»åŠ¡ç›¸å…³ä¸šåŠ¡é€»è¾‘  
- **Stats Service**: åªè´Ÿè´£ç»Ÿè®¡ç›¸å…³ä¸šåŠ¡é€»è¾‘
- **Notify Service**: åªè´Ÿè´£é€šçŸ¥ç›¸å…³ä¸šåŠ¡é€»è¾‘

### 2. å¼€æ”¾å°é—­åŸåˆ™ (OCP)
ç³»ç»Ÿå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å°é—­ï¼š
- é€šè¿‡æ¥å£å’ŒæŠ½è±¡ç±»å®šä¹‰å¥‘çº¦
- ä½¿ç”¨ä¾èµ–æ³¨å…¥å®ç°æ¾è€¦åˆ
- æ”¯æŒæ’ä»¶åŒ–æ‰©å±•æ–°åŠŸèƒ½

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡ï¼š
- Serviceå±‚ä¾èµ–Repositoryæ¥å£
- Controllerå±‚ä¾èµ–Serviceæ¥å£
- å…·ä½“å®ç°é€šè¿‡ä¾èµ–æ³¨å…¥æä¾›

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)
ä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£ï¼Œè€Œä¸æ˜¯å•ä¸€çš„æ€»æ¥å£ï¼š
- `IUserService` - ç”¨æˆ·æœåŠ¡æ¥å£
- `ITaskService` - ä»»åŠ¡æœåŠ¡æ¥å£
- `IStatsService` - ç»Ÿè®¡æœåŠ¡æ¥å£
- `INotifyService` - é€šçŸ¥æœåŠ¡æ¥å£

## ğŸ”§ æŠ€æœ¯æ¶æ„

### å‰ç«¯æ¶æ„

#### ç»„ä»¶æ¶æ„
```
src/
â”œâ”€â”€ components/           # å¯å¤ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ common/          # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â””â”€â”€ Card.tsx
â”‚   â”œâ”€â”€ business/        # ä¸šåŠ¡ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ TaskCard.tsx
â”‚   â”‚   â”œâ”€â”€ TimerDisplay.tsx
â”‚   â”‚   â”œâ”€â”€ StatusIndicator.tsx
â”‚   â”‚   â””â”€â”€ UserAvatar.tsx
â”‚   â””â”€â”€ layout/          # å¸ƒå±€ç»„ä»¶
â”‚       â”œâ”€â”€ Header.tsx
â”‚       â”œâ”€â”€ Sidebar.tsx
â”‚       â””â”€â”€ Footer.tsx
â”œâ”€â”€ pages/               # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ Login.tsx
â”‚   â”œâ”€â”€ Dashboard/
â”‚   â”‚   â”œâ”€â”€ Dispatcher.tsx
â”‚   â”‚   â””â”€â”€ Player.tsx
â”‚   â””â”€â”€ Task/
â”‚       â””â”€â”€ Focus.tsx
â”œâ”€â”€ hooks/              # è‡ªå®šä¹‰Hooks
â”‚   â”œâ”€â”€ useAuth.ts
â”‚   â”œâ”€â”€ useTasks.ts
â”‚   â”œâ”€â”€ usePlayers.ts
â”‚   â””â”€â”€ useSocket.ts
â”œâ”€â”€ store/              # çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ slices/          # çŠ¶æ€åˆ‡ç‰‡
â”‚   â”œâ”€â”€ index.ts         # Storeé…ç½®
â”‚   â””â”€â”€ middleware.ts   # ä¸­é—´ä»¶
â”œâ”€â”€ services/           # APIæœåŠ¡
â”‚   â”œâ”€â”€ api.ts
â”‚   â”œâ”€â”€ socket.ts
â”‚   â””â”€â”€ auth.ts
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ date.ts
â”‚   â”œâ”€â”€ validation.ts
â”‚   â””â”€â”€ constants.ts
â””â”€â”€ types/              # ç±»å‹å®šä¹‰
    â”œâ”€â”€ user.ts
    â”œâ”€â”€ task.ts
    â””â”€â”€ api.ts
```

#### çŠ¶æ€ç®¡ç† (Zustand)
```typescript
// store/index.ts
import { create } from 'zustand';
import { devtools, persist } from 'zustand/middleware';

interface AppState {
  // ç”¨æˆ·çŠ¶æ€
  user: User | null;
  isAuthenticated: boolean;
  
  // ä»»åŠ¡çŠ¶æ€
  tasks: Task[];
  currentTask: Task | null;
  
  // UIçŠ¶æ€
  loading: boolean;
  connected: boolean;
  
  // æ“ä½œæ–¹æ³•
  setUser: (user: User | null) => void;
  setTasks: (tasks: Task[]) => void;
  setLoading: (loading: boolean) => void;
}

export const useAppStore = create<AppState>()(
  devtools(
    persist(
      (set, get) => ({
        // çŠ¶æ€å®šä¹‰
        user: null,
        isAuthenticated: false,
        tasks: [],
        currentTask: null,
        loading: false,
        connected: false,
        
        // æ“ä½œæ–¹æ³•
        setUser: (user) => set({ user, isAuthenticated: !!user }),
        setTasks: (tasks) => set({ tasks }),
        // ... å…¶ä»–æ–¹æ³•
      }),
      {
        name: 'app-storage',
        partialize: (state) => ({ user: state.user }),
      }
    )
  )
);
```

#### è·¯ç”±é…ç½® (React Router v7)
```typescript
// router/AppRouter.tsx
import { createBrowserRouter, RouterProvider } from 'react-router-dom';
import { ProtectedRoute } from '../components/auth/ProtectedRoute';

const router = createBrowserRouter([
  {
    path: '/login',
    element: <LoginPage />,
  },
  {
    path: '/',
    element: <ProtectedRoute />,
    children: [
      {
        path: 'dispatcher',
        element: <DispatcherDashboard />,
        children: [
          { index: true, element: <TaskList /> },
          { path: 'tasks', element: <TaskManagement /> },
          { path: 'players', element: <PlayerManagement /> },
          { path: 'stats', element: <Statistics /> },
        ],
      },
      {
        path: 'player',
        element: <PlayerDashboard />,
        children: [
          { index: true, element: <MyTasks /> },
          { path: 'task/:id', element: <TaskDetail /> },
          { path: 'focus/:id', element: <TaskFocus /> },
          { path: 'stats', element: <MyStats /> },
        ],
      },
    ],
  },
  {
    path: '*',
    element: <NotFound />,
  },
]);
```

### åç«¯æ¶æ„

#### æœåŠ¡åˆ†å±‚æ¶æ„
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/      # æ§åˆ¶å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”‚   â”œâ”€â”€ task.controller.ts
â”‚   â”‚   â””â”€â”€ stats.controller.ts
â”‚   â”œâ”€â”€ services/         # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ user.service.ts
â”‚   â”‚   â”œâ”€â”€ task.service.ts
â”‚   â”‚   â””â”€â”€ stats.service.ts
â”‚   â”œâ”€â”€ repositories/     # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ user.repository.ts
â”‚   â”‚   â”œâ”€â”€ task.repository.ts
â”‚   â”‚   â””â”€â”€ stats.repository.ts
â”‚   â”œâ”€â”€ models/          # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.model.ts
â”‚   â”‚   â”œâ”€â”€ task.model.ts
â”‚   â”‚   â””â”€â”€ base.model.ts
â”‚   â”œâ”€â”€ dto/             # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ auth.dto.ts
â”‚   â”‚   â”œâ”€â”€ user.dto.ts
â”‚   â”‚   â””â”€â”€ task.dto.ts
â”‚   â”œâ”€â”€ middleware/      # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”œâ”€â”€ validation.middleware.ts
â”‚   â”‚   â”œâ”€â”€ rate-limit.middleware.ts
â”‚   â”‚   â””â”€â”€ error.middleware.ts
â”‚   â”œâ”€â”€ sockets/         # Socketå¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ task.socket.ts
â”‚   â”‚   â”œâ”€â”€ user.socket.ts
â”‚   â”‚   â””â”€â”€ stats.socket.ts
â”‚   â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ validator.ts
â”‚   â”‚   â”œâ”€â”€ crypto.ts
â”‚   â”‚   â””â”€â”€ response.ts
â”‚   â””â”€â”€ config/          # é…ç½®
â”‚       â”œâ”€â”€ database.ts
â”‚       â”œâ”€â”€ redis.ts
â”‚       â””â”€â”€ app.ts
```

#### æ§åˆ¶å™¨æ¨¡å¼
```typescript
// controllers/task.controller.ts
import { Request, Response } from 'express';
import { TaskService } from '../services/task.service';
import { CreateTaskDto, UpdateTaskDto } from '../dto/task.dto';
import { validateRequest } from '../middleware/validation.middleware';

export class TaskController {
  private taskService: TaskService;

  constructor() {
    this.taskService = new TaskService();
  }

  @validateRequest(CreateTaskDto)
  async createTask(req: Request, res: Response): Promise<void> {
    try {
      const taskData: CreateTaskDto = req.body;
      const dispatcherId = req.user.id;
      
      const result = await this.taskService.createTask({
        ...taskData,
        dispatcherId,
      });

      res.status(201).json({
        success: true,
        data: result,
        message: 'Task created successfully',
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: error.message,
      });
    }
  }

  async getTasks(req: Request, res: Response): Promise<void> {
    try {
      const { page = 1, limit = 20, status, playerId } = req.query;
      const filters = { status, playerId };
      
      const result = await this.taskService.getTasks({
        page: Number(page),
        limit: Number(limit),
        filters,
      });

      res.json({
        success: true,
        data: result,
      });
    } catch (error) {
      res.status(500).json({
        success: false,
        message: error.message,
      });
    }
  }
}
```

#### æœåŠ¡å±‚æ¨¡å¼
```typescript
// services/task.service.ts
import { TaskRepository } from '../repositories/task.repository';
import { UserRepository } from '../repositories/user.repository';
import { EventEmitter } from 'events';
import { Task } from '../models/task.model';

export class TaskService extends EventEmitter {
  private taskRepository: TaskRepository;
  private userRepository: UserRepository;

  constructor() {
    super();
    this.taskRepository = new TaskRepository();
    this.userRepository = new UserRepository();
  }

  async createTask(taskData: CreateTaskInput): Promise<Task> {
    // éªŒè¯ç”¨æˆ·æƒé™
    const dispatcher = await this.userRepository.findById(taskData.dispatcherId);
    if (!dispatcher || dispatcher.role !== 'dispatcher') {
      throw new Error('Unauthorized dispatcher');
    }

    // å¦‚æœæŒ‡å®šäº†é™ªç©å‘˜ï¼ŒéªŒè¯å…¶çŠ¶æ€
    if (taskData.playerId) {
      const player = await this.userRepository.findById(taskData.playerId);
      if (!player || player.role !== 'player') {
        throw new Error('Invalid player');
      }
      if (player.status !== 'idle') {
        throw new Error('Player is not available');
      }
    }

    // åˆ›å»ºä»»åŠ¡
    const task = await this.taskRepository.create({
      ...taskData,
      status: taskData.playerId ? 'accepted' : 'pending',
    });

    // å¦‚æœæŒ‡å®šäº†é™ªç©å‘˜ï¼Œæ›´æ–°å…¶çŠ¶æ€
    if (taskData.playerId) {
      await this.userRepository.updateStatus(taskData.playerId, 'busy');
    }

    // å‘é€äº‹ä»¶é€šçŸ¥
    this.emit('taskCreated', task);

    return task;
  }

  async assignTask(taskId: number, playerId: number): Promise<Task> {
    const task = await this.taskRepository.findById(taskId);
    if (!task) {
      throw new Error('Task not found');
    }

    if (task.status !== 'pending') {
      throw new Error('Task cannot be assigned');
    }

    const player = await this.userRepository.findById(playerId);
    if (!player || player.status !== 'idle') {
      throw new Error('Player is not available');
    }

    // æ›´æ–°ä»»åŠ¡
    const updatedTask = await this.taskRepository.update(taskId, {
      playerId,
      status: 'accepted',
      acceptedAt: new Date(),
    });

    // æ›´æ–°é™ªç©å‘˜çŠ¶æ€
    await this.userRepository.updateStatus(playerId, 'busy');

    // å‘é€äº‹ä»¶é€šçŸ¥
    this.emit('taskAssigned', updatedTask);

    return updatedTask;
  }
}
```

#### Repositoryæ¨¡å¼
```typescript
// repositories/task.repository.ts
import { pool } from '../config/database';
import { Task } from '../models/task.model';
import { BaseRepository } from './base.repository';

export class TaskRepository extends BaseRepository<Task> {
  constructor() {
    super('tasks');
  }

  async create(taskData: Omit<Task, 'id' | 'created_at'>): Promise<Task> {
    const query = `
      INSERT INTO tasks (customer_name, customer_contact, game_name, game_mode, 
                      duration, price, requirements, dispatcher_id, player_id, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;
    
    const [result] = await pool.execute(query, [
      taskData.customer_name,
      taskData.customer_contact,
      taskData.game_name,
      taskData.game_mode,
      taskData.duration,
      taskData.price,
      taskData.requirements || '',
      taskData.dispatcher_id,
      taskData.player_id || null,
      taskData.status,
    ]);

    return this.findById(result.insertId);
  }

  async findById(id: number): Promise<Task | null> {
    const query = `
      SELECT t.*, 
             u1.username as dispatcher_name,
             u2.username as player_name
      FROM tasks t
      LEFT JOIN users u1 ON t.dispatcher_id = u1.id
      LEFT JOIN users u2 ON t.player_id = u2.id
      WHERE t.id = ?
    `;
    
    const [rows] = await pool.execute(query, [id]);
    return rows[0] || null;
  }

  async findWithFilters(filters: TaskFilters): Promise<{ tasks: Task[], total: number }> {
    let query = `
      SELECT t.*, 
             u1.username as dispatcher_name,
             u2.username as player_name
      FROM tasks t
      LEFT JOIN users u1 ON t.dispatcher_id = u1.id
      LEFT JOIN users u2 ON t.player_id = u2.id
      WHERE 1=1
    `;
    
    const params: any[] = [];
    
    if (filters.status) {
      query += ' AND t.status = ?';
      params.push(filters.status);
    }
    
    if (filters.playerId) {
      query += ' AND t.player_id = ?';
      params.push(filters.playerId);
    }
    
    if (filters.dispatcherId) {
      query += ' AND t.dispatcher_id = ?';
      params.push(filters.dispatcherId);
    }
    
    // è·å–æ€»æ•°
    const countQuery = query.replace('SELECT t.*, u1.username as dispatcher_name, u2.username as player_name', 'SELECT COUNT(*) as total');
    const [countResult] = await pool.execute(countQuery, params);
    const total = countResult[0].total;
    
    // æ·»åŠ æ’åºå’Œåˆ†é¡µ
    query += ' ORDER BY t.created_at DESC';
    query += ' LIMIT ? OFFSET ?';
    params.push(filters.limit, filters.offset);
    
    const [rows] = await pool.execute(query, params);
    
    return {
      tasks: rows,
      total,
    };
  }
}
```

## ğŸŒ æ•°æ®åº“æ¶æ„

### ERå›¾è®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1:N    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      tasks       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)        â”‚           â”‚ id (PK)         â”‚
â”‚ username       â”‚           â”‚ customer_name   â”‚
â”‚ password       â”‚           â”‚ customer_contactâ”‚
â”‚ role           â”‚           â”‚ game_name       â”‚
â”‚ status         â”‚           â”‚ game_mode       â”‚
â”‚ created_at     â”‚           â”‚ duration        â”‚
â”‚ updated_at     â”‚           â”‚ price           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ requirements   â”‚
                             â”‚ dispatcher_id  â”‚ (FK)
                             â”‚ player_id       â”‚ (FK)
                             â”‚ status          â”‚
                             â”‚ created_at      â”‚
                             â”‚ accepted_at     â”‚
                             â”‚ started_at      â”‚
                             â”‚ completed_at    â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ 1:N
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    task_logs     â”‚
                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚ id (PK)         â”‚
                          â”‚ task_id (FK)    â”‚
                          â”‚ user_id (FK)    â”‚
                          â”‚ action          â”‚
                          â”‚ details         â”‚
                          â”‚ created_at      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨ç»“æ„è®¾è®¡

#### ç”¨æˆ·è¡¨ (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç (åŠ å¯†)',
    role ENUM('dispatcher', 'player') NOT NULL COMMENT 'ç”¨æˆ·è§’è‰²',
    status ENUM('idle', 'busy', 'offline') DEFAULT 'idle' COMMENT 'ç”¨æˆ·çŠ¶æ€',
    email VARCHAR(100) UNIQUE COMMENT 'é‚®ç®±',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    avatar VARCHAR(255) COMMENT 'å¤´åƒURL',
    last_login_at TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_username (username),
    INDEX idx_role_status (role, status),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

#### ä»»åŠ¡è¡¨ (tasks)
```sql
CREATE TABLE tasks (
    id INT PRIMARY KEY AUTO_INCREMENT,
    customer_name VARCHAR(100) NOT NULL COMMENT 'å®¢æˆ·å§“å',
    customer_contact VARCHAR(50) NOT NULL COMMENT 'å®¢æˆ·è”ç³»æ–¹å¼',
    game_name VARCHAR(100) NOT NULL COMMENT 'æ¸¸æˆåç§°',
    game_mode VARCHAR(100) NOT NULL COMMENT 'æ¸¸æˆæ¨¡å¼',
    duration INT NOT NULL COMMENT 'ä»»åŠ¡æ—¶é•¿(åˆ†é’Ÿ)',
    price DECIMAL(10,2) NOT NULL COMMENT 'ä»»åŠ¡ä»·æ ¼',
    requirements TEXT COMMENT 'ç‰¹æ®Šè¦æ±‚',
    dispatcher_id INT NOT NULL COMMENT 'æ´¾å•å‘˜ID',
    player_id INT NULL COMMENT 'é™ªç©å‘˜ID',
    status ENUM('pending', 'accepted', 'in_progress', 'completed', 'cancelled') 
           DEFAULT 'pending' COMMENT 'ä»»åŠ¡çŠ¶æ€',
    priority ENUM('low', 'normal', 'high') DEFAULT 'normal' COMMENT 'ä¼˜å…ˆçº§',
    estimated_start_time TIMESTAMP NULL COMMENT 'é¢„è®¡å¼€å§‹æ—¶é—´',
    actual_start_time TIMESTAMP NULL COMMENT 'å®é™…å¼€å§‹æ—¶é—´',
    actual_end_time TIMESTAMP NULL COMMENT 'å®é™…ç»“æŸæ—¶é—´',
    completion_note TEXT COMMENT 'å®Œæˆå¤‡æ³¨',
    rating INT NULL COMMENT 'è¯„åˆ†(1-5)',
    review TEXT COMMENT 'è¯„ä»·å†…å®¹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (dispatcher_id) REFERENCES users(id),
    FOREIGN KEY (player_id) REFERENCES users(id),
    INDEX idx_status (status),
    INDEX idx_player_id (player_id),
    INDEX idx_dispatcher_id (dispatcher_id),
    INDEX idx_created_at (created_at),
    INDEX idx_status_created (status, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»»åŠ¡è¡¨';
```

#### ä»»åŠ¡æ—¥å¿—è¡¨ (task_logs)
```sql
CREATE TABLE task_logs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    task_id INT NOT NULL COMMENT 'ä»»åŠ¡ID',
    user_id INT NOT NULL COMMENT 'æ“ä½œç”¨æˆ·ID',
    action VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    old_values JSON NULL COMMENT 'æ—§å€¼(JSON)',
    new_values JSON NULL COMMENT 'æ–°å€¼(JSON)',
    note TEXT COMMENT 'å¤‡æ³¨',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_task_id (task_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä»»åŠ¡æ—¥å¿—è¡¨';
```

#### ç”¨æˆ·ä¼šè¯è¡¨ (user_sessions)
```sql
CREATE TABLE user_sessions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',
    session_token VARCHAR(255) UNIQUE NOT NULL COMMENT 'ä¼šè¯ä»¤ç‰Œ',
    refresh_token VARCHAR(255) NOT NULL COMMENT 'åˆ·æ–°ä»¤ç‰Œ',
    expires_at TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_active_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_revoked BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å·²æ’¤é”€',
    device_info JSON COMMENT 'è®¾å¤‡ä¿¡æ¯',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_session_token (session_token),
    INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¼šè¯è¡¨';
```

#### ç»Ÿè®¡æ•°æ®è¡¨ (statistics)
```sql
CREATE TABLE daily_statistics (
    id INT PRIMARY KEY AUTO_INCREMENT,
    date DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    user_id INT NULL COMMENT 'ç”¨æˆ·ID(ä¸ºç©ºåˆ™è¡¨ç¤ºå…¨å±€ç»Ÿè®¡)',
    role ENUM('dispatcher', 'player') NULL COMMENT 'ç”¨æˆ·è§’è‰²',
    
    -- ä»»åŠ¡ç»Ÿè®¡
    total_tasks INT DEFAULT 0 COMMENT 'æ€»ä»»åŠ¡æ•°',
    completed_tasks INT DEFAULT 0 COMMENT 'å·²å®Œæˆä»»åŠ¡æ•°',
    cancelled_tasks INT DEFAULT 0 COMMENT 'å·²å–æ¶ˆä»»åŠ¡æ•°',
    
    -- æ—¶é—´ç»Ÿè®¡
    total_duration INT DEFAULT 0 COMMENT 'æ€»æ—¶é•¿(åˆ†é’Ÿ)',
    average_duration DECIMAL(5,2) DEFAULT 0 COMMENT 'å¹³å‡æ—¶é•¿(åˆ†é’Ÿ)',
    
    -- æ”¶å…¥ç»Ÿè®¡
    total_revenue DECIMAL(12,2) DEFAULT 0 COMMENT 'æ€»æ”¶å…¥',
    average_price DECIMAL(10,2) DEFAULT 0 COMMENT 'å¹³å‡ä»·æ ¼',
    
    -- æ€§èƒ½ç»Ÿè®¡
    completion_rate DECIMAL(5,2) DEFAULT 0 COMMENT 'å®Œæˆç‡(%)',
    rating_avg DECIMAL(3,2) NULL COMMENT 'å¹³å‡è¯„åˆ†',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY uk_date_user_role (date, user_id, role),
    INDEX idx_date (date),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ—¥ç»Ÿè®¡è¡¨';
```

### æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_tasks_player_status_created 
ON tasks(player_id, status, created_at);

CREATE INDEX idx_tasks_dispatcher_status 
ON tasks(dispatcher_id, status);

CREATE INDEX idx_task_logs_task_created 
ON task_logs(task_id, created_at);

-- å…¨æ–‡ç´¢å¼•æ”¯æŒæœç´¢
CREATE FULLTEXT INDEX idx_tasks_game_search 
ON tasks(game_name, game_mode, requirements);
```

#### åˆ†åŒºç­–ç•¥
```sql
-- æŒ‰æœˆåˆ†åŒºä»»åŠ¡æ—¥å¿—è¡¨
ALTER TABLE task_logs 
PARTITION BY RANGE (TO_DAYS(created_at)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p202503 VALUES LESS THAN (TO_DAYS('2025-04-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

#### è¯»å†™åˆ†ç¦»
```sql
-- ä¸»åº“é…ç½® (å†™æ“ä½œ)
CREATE DATABASE playmanager_master;

-- ä»åº“é…ç½® (è¯»æ“ä½œ)
CREATE DATABASE playmanager_slave;

-- å¤åˆ¶ç”¨æˆ·è®¾ç½®
CREATE USER 'replicator'@'%' IDENTIFIED BY 'password';
GRANT REPLICATION SLAVE ON *.* TO 'replicator'@'%';
```

## ğŸ” å®‰å…¨æ¶æ„

### è®¤è¯æˆæƒæµç¨‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•   â”‚â”€â”€â”€â–ºâ”‚  éªŒè¯ç”¨æˆ·å  â”‚â”€â”€â”€â–ºâ”‚  ç”ŸæˆJWT    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   å¯†ç       â”‚    â”‚   Token      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tokenå­˜å‚¨  â”‚â—„â”€â”€â”€â”‚  ä¼šè¯ç®¡ç†    â”‚â—„â”€â”€â”€â”‚  æƒé™æ£€æŸ¥    â”‚
â”‚   (HttpOnly) â”‚    â”‚   (Redis)    â”‚    â”‚   (RBAC)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®‰å…¨æªæ–½

#### 1. è¾“å…¥éªŒè¯
```typescript
// DTOéªŒè¯
import { IsString, IsEmail, IsEnum, IsOptional, Min, Max } from 'class-validator';

export class CreateTaskDto {
  @IsString()
  @MinLength(1)
  @MaxLength(100)
  customer_name: string;

  @IsString()
  @MinLength(1)
  @MaxLength(50)
  customer_contact: string;

  @IsString()
  @MinLength(1)
  @MaxLength(100)
  game_name: string;

  @IsEnum(['league-of-legends', 'valorant', 'pubg', 'other'])
  game_mode: string;

  @IsInt()
  @Min(1)
  @Max(1440) // 24å°æ—¶
  duration: number;

  @IsNumber()
  @Min(0)
  price: number;

  @IsOptional()
  @IsString()
  @MaxLength(1000)
  requirements?: string;
}
```

#### 2. SQLæ³¨å…¥é˜²æŠ¤
```typescript
// ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
const query = `
  SELECT * FROM tasks 
  WHERE dispatcher_id = ? AND status = ?
  ORDER BY created_at DESC
  LIMIT ? OFFSET ?
`;

const [rows] = await pool.execute(query, [dispatcherId, status, limit, offset]);
```

#### 3. XSSé˜²æŠ¤
```typescript
// è¾“å‡ºè½¬ä¹‰
import xss from 'xss';

function sanitizeOutput(data: any): any {
  if (typeof data === 'string') {
    return xss(data);
  }
  if (Array.isArray(data)) {
    return data.map(sanitizeOutput);
  }
  if (data && typeof data === 'object') {
    const result: any = {};
    for (const [key, value] of Object.entries(data)) {
      result[key] = sanitizeOutput(value);
    }
    return result;
  }
  return data;
}
```

#### 4. CSRFé˜²æŠ¤
```typescript
// CSRF Token
import { csrf } from 'csurf';

const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
  },
});

app.use(csrfProtection);
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### 1. ä»£ç åˆ†å‰²
```typescript
// è·¯ç”±çº§åˆ«ä»£ç åˆ†å‰²
const Dashboard = React.lazy(() => import('./pages/Dashboard'));
const TaskManagement = React.lazy(() => import('./pages/TaskManagement'));

function App() {
  return (
    <Suspense fallback={<LoadingSpinner />}>
      <Routes>
        <Route path="/dashboard" element={<Dashboard />} />
        <Route path="/tasks" element={<TaskManagement />} />
      </Routes>
    </Suspense>
  );
}
```

#### 2. ç¼“å­˜ç­–ç•¥
```typescript
// APIç¼“å­˜
const apiCache = new Map();

async function cachedFetch(url: string, options?: RequestInit) {
  const cacheKey = `${url}-${JSON.stringify(options)}`;
  
  if (apiCache.has(cacheKey)) {
    return apiCache.get(cacheKey);
  }
  
  const response = await fetch(url, options);
  const data = await response.json();
  
  // ç¼“å­˜5åˆ†é’Ÿ
  apiCache.set(cacheKey, data);
  setTimeout(() => apiCache.delete(cacheKey), 5 * 60 * 1000);
  
  return data;
}
```

#### 3. è™šæ‹Ÿæ»šåŠ¨
```typescript
// å¤§åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨
const VirtualizedList = ({ items, renderItem, itemHeight }) => {
  const [scrollTop, setScrollTop] = useState(0);
  
  const startIndex = Math.floor(scrollTop / itemHeight);
  const endIndex = Math.min(
    startIndex + Math.ceil(window.innerHeight / itemHeight) + 1,
    items.length
  );
  
  const visibleItems = items.slice(startIndex, endIndex);
  
  return (
    <div 
      style={{ height: items.length * itemHeight, overflowY: 'auto' }}
      onScroll={(e) => setScrollTop(e.target.scrollTop)}
    >
      <div style={{ height: startIndex * itemHeight }} />
      {visibleItems.map((item, index) => (
        <div key={item.id} style={{ height: itemHeight }}>
          {renderItem(item)}
        </div>
      ))}
      <div style={{ height: (items.length - endIndex) * itemHeight }} />
    </div>
  );
};
```

### åç«¯æ€§èƒ½ä¼˜åŒ–

#### 1. æ•°æ®åº“ä¼˜åŒ–
```typescript
// è¿æ¥æ± é…ç½®
const pool = mysql.createPool({
  connectionLimit: 20,
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  acquireTimeout: 60000,
  timeout: 60000,
  reconnect: true,
  multipleStatements: false,
});

// æŸ¥è¯¢ä¼˜åŒ–
async function getTasksWithPagination(filters: TaskFilters) {
  const { page = 1, limit = 20, ...where } = filters;
  const offset = (page - 1) * limit;
  
  // ä½¿ç”¨é¢„å¤„ç†è¯­å¥é˜²æ­¢SQLæ³¨å…¥
  const query = `
    SELECT t.*, u.username as dispatcher_name
    FROM tasks t
    LEFT JOIN users u ON t.dispatcher_id = u.id
    WHERE ${Object.entries(where).map(([key, value]) => 
      `${key} = ?`
    ).join(' AND ')}
    ORDER BY t.created_at DESC
    LIMIT ? OFFSET ?
  `;
  
  const params = [...Object.values(where), limit, offset];
  const [rows] = await pool.execute(query, params);
  
  return rows;
}
```

#### 2. Redisç¼“å­˜
```typescript
// Redisç¼“å­˜æœåŠ¡
import { createClient } from 'redis';

const redisClient = createClient({
  host: process.env.REDIS_HOST,
  port: parseInt(process.env.REDIS_PORT || '6379'),
  password: process.env.REDIS_PASSWORD,
});

class CacheService {
  async get<T>(key: string): Promise<T | null> {
    const cached = await redisClient.get(key);
    return cached ? JSON.parse(cached) : null;
  }
  
  async set(key: string, value: any, ttl: number = 3600): Promise<void> {
    await redisClient.setEx(key, ttl, JSON.stringify(value));
  }
  
  async del(key: string): Promise<void> {
    await redisClient.del(key);
  }
  
  // ç¼“å­˜å‡»ç©¿ä¿æŠ¤
  async getWithFallback<T>(
    key: string, 
    fallback: () => Promise<T>, 
    ttl: number = 3600
  ): Promise<T> {
    const cached = await this.get<T>(key);
    if (cached !== null) {
      return cached;
    }
    
    const data = await fallback();
    await this.set(key, data, ttl);
    return data;
  }
}
```

#### 3. APIå“åº”ä¼˜åŒ–
```typescript
// å“åº”å‹ç¼©
import compression from 'compression';

app.use(compression({
  level: 6,
  threshold: 1024,
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  },
}));

// åˆ†é¡µå“åº”
interface PaginatedResponse<T> {
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}

function createPaginatedResponse<T>(
  data: T[],
  page: number,
  limit: number,
  total: number
): PaginatedResponse<T> {
  return {
    data,
    pagination: {
      page,
      limit,
      total,
      totalPages: Math.ceil(total / limit),
    },
  };
}
```

### WebSocketä¼˜åŒ–

#### 1. è¿æ¥ç®¡ç†
```typescript
// Socket.ioè¿æ¥ä¼˜åŒ–
const io = new Server(httpServer, {
  cors: {
    origin: process.env.ALLOWED_ORIGINS?.split(',') || ['http://localhost:3000'],
    methods: ['GET', 'POST'],
    credentials: true,
  },
  transports: ['websocket', 'polling'],
  pingTimeout: 60000,
  pingInterval: 25000,
});

// è¿æ¥é™æµ
const connectionLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // æ¯ä¸ªIPæœ€å¤š100ä¸ªè¿æ¥
  message: 'Too many connection attempts',
});

io.use(connectionLimiter);
```

#### 2. æˆ¿é—´ç®¡ç†
```typescript
// æˆ¿é—´ç®¡ç†ä¼˜åŒ–
class RoomManager {
  private rooms: Map<string, Set<string>> = new Map();
  
  joinRoom(socketId: string, room: string): void {
    if (!this.rooms.has(room)) {
      this.rooms.set(room, new Set());
    }
    this.rooms.get(room)!.add(socketId);
  }
  
  leaveRoom(socketId: string, room: string): void {
    const roomSockets = this.rooms.get(room);
    if (roomSockets) {
      roomSockets.delete(socketId);
      if (roomSockets.size === 0) {
        this.rooms.delete(room);
      }
    }
  }
  
  broadcastToRoom(room: string, event: string, data: any): void {
    const roomSockets = this.rooms.get(room);
    if (roomSockets) {
      roomSockets.forEach(socketId => {
        const socket = io.sockets.sockets.get(socketId);
        if (socket && socket.connected) {
          socket.emit(event, data);
        }
      });
    }
  }
}
```

---

*æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†é™ªç©ç®¡ç†ç³»ç»Ÿçš„å®Œæ•´æŠ€æœ¯æ¶æ„ï¼Œä¸ºå¼€å‘å’Œéƒ¨ç½²æä¾›æŒ‡å¯¼ã€‚*

**æœ€åæ›´æ–°**: 2025-08-26  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**è´Ÿè´£äºº**: æ¶æ„å›¢é˜Ÿ