# 陪玩员倒计时提醒和加钟功能

## 功能概览

本功能实现了以下需求：
1. **声音提醒**: 陪玩员在专注页面倒计时剩余15分钟和5分钟时会播放提醒音效
2. **加钟申请**: 陪玩员可快速申请延长时间（+15min/+30min/+60min），需派单员审核
3. **直接延长**: 派单员可直接编辑任务增加时间，立即生效

## 实施的功能

### 1. 数据库变更
- 新增 `time_extension_requests` 表存储加钟申请
- 为 `tasks` 表添加 `original_duration` 字段记录原始时长
- 扩展日志系统支持时间变更记录

### 2. 后端 API 扩展
- `POST /api/tasks/:id/request-extension` - 陪玩员申请加钟
- `PUT /api/tasks/:id/extend-duration` - 派单员直接延长时间  
- `GET /api/tasks/extension-requests` - 获取待审核的加钟申请
- `PUT /api/tasks/extension-requests/:id/review` - 审核加钟申请

### 3. 前端功能

#### 陪玩员专注页面 (`/player/focus`)
- **声音提醒**: 剩余15分钟和5分钟时自动播放提醒音效
- **声音开关**: 右上角音量按钮可开启/关闭声音提醒
- **加钟申请**: 提醒后自动显示加钟申请按钮组
- **快速申请**: 一键申请+15分钟/+30分钟/+1小时延长

#### 派单员仪表盘 (`/dispatcher`)
- **查看延长申请**: 顶部按钮切换显示待审核申请面板
- **任务列表**: 进行中的任务可直接点击"延长"按钮
- **审核界面**: 清晰显示申请详情，支持一键通过/拒绝
- **直接延长**: 支持自定义延长时间和理由

### 4. 实时通信
- Socket.io 实时推送延长申请和审核结果
- 任务时长变更实时同步到相关用户

## 部署步骤

### 1. 数据库迁移
```sql
-- 运行数据库迁移文件
mysql -u [username] -p [database] < backend/migrations/add_time_extension_features.sql
```

### 2. 音频文件
将提醒音效文件放置到 `frontend/public/notification-sound.mp3`
- 建议格式: MP3
- 建议时长: 2-3秒
- 音量适中，不刺耳

### 3. 启动服务
```bash
# 启动后端
cd backend
npm run dev

# 启动前端  
cd frontend
npm run dev
```

## 功能测试流程

### 测试场景1: 声音提醒
1. 创建一个20分钟的任务并指派给陪玩员
2. 陪玩员接受任务并进入专注页面
3. 修改任务开始时间，使剩余时间接近15分钟
4. 验证音效播放和提示消息
5. 测试音效开关功能

### 测试场景2: 加钟申请流程
1. 陪玩员在专注页面点击加钟按钮申请+30分钟
2. 派单员在仪表盘查看延长申请面板
3. 审核通过申请，验证任务时长更新
4. 陪玩员页面实时显示时长变化

### 测试场景3: 直接延长
1. 派单员在任务列表点击"延长"按钮
2. 选择延长时间（如+1小时）
3. 确认延长，验证任务时长立即更新
4. 陪玩员专注页面实时更新倒计时

## 技术特点

- **权限控制**: 严格的角色权限验证
- **数据一致性**: 使用数据库事务确保操作原子性
- **实时同步**: WebSocket 实时推送状态变更
- **用户体验**: 清晰的状态指示和操作反馈
- **安全性**: 输入验证和SQL注入防护
- **可维护性**: 模块化代码结构和完整的错误处理

## 注意事项

1. **音频权限**: 现代浏览器需要用户交互后才能自动播放音频
2. **时间同步**: 确保服务器和客户端时间同步
3. **网络异常**: 处理网络中断时的状态恢复
4. **并发控制**: 防止重复提交申请
5. **日志记录**: 完整的操作审计轨迹

这个功能增强了陪玩管理系统的实用性，提升了服务质量和客户满意度。